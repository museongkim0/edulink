pipeline {
    agent any

    options {
        timestamps()
    }

    environment {
        IMAGE_NAME = 'mstar228/edulink-backend'
        IMAGE_TAG = "1.0.${BUILD_NUMBER}"
        KUBE_HOST = 'test@192.0.2.7'
        PATH = "/usr/local/bin:${env.PATH}"
    }

    stages {
        stage('Start Timer') {
            steps {
                script {
                    startTime = System.currentTimeMillis()
                }
            }
        }

        stage('Git Clone') {
            steps {
                echo "Cloning Repository"
                git url: 'https://github.com/beyond-sw-camp/be12-4th-404Error-EduLink.git',
                    branch: "${env.GIT_BRANCH.replace('origin/', '')}"
            }
            post {
                success {
                    sendDiscordMessage("âœ… Git Clone ì„±ê³µ!", "Git Repository í´ë¡  ì™„ë£Œ", "GREEN")
                }
                failure {
                    sendDiscordMessage("âŒ Git Clone ì‹¤íŒ¨!", "Git Repository í´ë¡  ì¤‘ ì˜¤ë¥˜ ë°œìƒ", "RED")
                }
            }
        }

        stage('Gradle Build') {
            steps {
                echo "Building Project"
                sh '''
                    echo "Add Permission"
                    chmod +x ${WORKSPACE}/backend/gradlew
                    echo "Cleaning previous build"
                    rm -rf ${WORKSPACE}/backend/build
                    echo "Running Gradle build"
                    cd ${WORKSPACE}/backend && ./gradlew bootJar
                '''
            }
            post {
                success {
                    sendDiscordMessage("âœ… Gradle Build ì„±ê³µ!", "Spring Boot ë¹Œë“œ ì™„ë£Œ", "GREEN")
                }
                failure {
                    sendDiscordMessage("âŒ Gradle Build ì‹¤íŒ¨!", "Spring Boot ë¹Œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ", "RED")
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    echo "Building Docker Image ${IMAGE_NAME}:${IMAGE_TAG}"
                    docker.build("${IMAGE_NAME}:${IMAGE_TAG}", "${WORKSPACE}/backend")
                }
            }
            post {
                success {
                    sendDiscordMessage("âœ… Docker Build ì„±ê³µ!", "Docker ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ", "GREEN")
                }
                failure {
                    sendDiscordMessage("âŒ Docker Build ì‹¤íŒ¨!", "Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ", "RED")
                }
            }
        }

        stage('Push to Registry') {
            steps {
                script {
                    echo "Pushing Docker Image ${IMAGE_NAME}:${IMAGE_TAG} to Registry"
                    withDockerRegistry([credentialsId: 'DOCKER_HUB']) {
                        docker.image("${IMAGE_NAME}:${IMAGE_TAG}").push()
                        docker.image("${IMAGE_NAME}:${IMAGE_TAG}").push('latest')
                    }
                }
            }
            post {
                success {
                    sendDiscordMessage("âœ… Docker Push ì„±ê³µ!", "Docker ì´ë¯¸ì§€ í‘¸ì‹œ ì™„ë£Œ", "GREEN")
                }
                failure {
                    sendDiscordMessage("âŒ Docker Push ì‹¤íŒ¨!", "Docker ì´ë¯¸ì§€ í‘¸ì‹œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ", "RED")
                }
            }
        }

        stage('Determine Deploy Color') {
            steps {
                script {
                    try {
                        // Query the current service selector to see which deployment is active.
                        def svcSelector = sh(
                            script: "ssh ${KUBE_HOST} 'kubectl get svc backend-svc -o jsonpath=\"{.spec.selector.app}\"'",
                            returnStdout: true
                        ).trim()
                        echo "Current svc selector: ${svcSelector}"

                        if (svcSelector.contains("green")) {
                            // Service is pointing to green; new deployment should be blue.
                            env.DEPLOY_COLOR = 'blue'
                            env.OTHER_COLOR = 'green'
                        } else if (svcSelector.contains("blue")) {
                            // Service is pointing to blue; new deployment should be green.
                            env.DEPLOY_COLOR = 'green'
                            env.OTHER_COLOR = 'blue'
                        } else {
                            // Fallback: Check ready replicas if the svc selector is not as expected.
                            def blueReady = sh(
                                script: "ssh ${KUBE_HOST} 'kubectl get deployment backend-deployment-blue -o jsonpath=\"{.status.readyReplicas}\"' || echo '0'",
                                returnStdout: true
                            ).trim()
                            def greenReady = sh(
                                script: "ssh ${KUBE_HOST} 'kubectl get deployment backend-deployment-green -o jsonpath=\"{.status.readyReplicas}\"' || echo '0'",
                                returnStdout: true
                            ).trim()
                            echo "Blue ready replicas: ${blueReady}"
                            echo "Green ready replicas: ${greenReady}"

                            if (blueReady == '0' && greenReady != '0') {
                                env.DEPLOY_COLOR = 'blue'
                                env.OTHER_COLOR = 'green'
                            } else if (blueReady != '0' && greenReady == '0') {
                                env.DEPLOY_COLOR = 'green'
                                env.OTHER_COLOR = 'blue'
                            } else {
                                // If ambiguous, default to deploying blue.
                                env.DEPLOY_COLOR = 'blue'
                                env.OTHER_COLOR = 'green'
                            }
                        }
                        echo "Deploying ${env.DEPLOY_COLOR} version (scaling down ${env.OTHER_COLOR} later)"
                    } catch (Exception e) {
                        echo "Error determining deploy color: ${e.getMessage()}"
                        // On error, default to blue deployment.
                        env.DEPLOY_COLOR = 'blue'
                        env.OTHER_COLOR = 'green'
                    }
                }
            }
            post {
                success {
                    sendDiscordMessage("âœ… ë°°í¬ ìƒ‰ìƒ ê²°ì • ì™„ë£Œ!", "${env.DEPLOY_COLOR} ë²„ì „ìœ¼ë¡œ ë°°í¬ ì§„í–‰", "GREEN")
                }
                failure {
                    sendDiscordMessage("âŒ ë°°í¬ ìƒ‰ìƒ ê²°ì • ì‹¤íŒ¨!", "ìƒ‰ìƒ ê²°ì • ì¤‘ ì˜¤ë¥˜ ë°œìƒ", "RED")
                }
            }
        }

        stage('Deploy Blue-Green') {
            when {
                expression { env.GIT_BRANCH == 'origin/main' }
            }
            steps {
                script {
                    def deployColor = env.DEPLOY_COLOR ?: 'blue'
                    def otherColor = env.OTHER_COLOR ?: 'green'

                    echo "Deploying ${deployColor} version"

                    // 1. ë°°í¬ íŒŒì¼ì˜ ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸ í›„ ì „ì†¡
                    sh """
                        sed -i "s/latest/${IMAGE_TAG}/g" ${WORKSPACE}/backend/k8s/backend-deployment-${deployColor}.yml
                    """
                    sh """
                        scp ${WORKSPACE}/backend/k8s/backend-deployment-${deployColor}.yml ${KUBE_HOST}:/home/test/backend/k8s/
                    """

                    // 2. ìƒˆ ë°°í¬ ì ìš© ë° ìŠ¤ì¼€ì¼ ì—…
                    sh """
                        ssh ${KUBE_HOST} 'kubectl apply -f /home/test/backend/k8s/backend-deployment-${deployColor}.yml'
                        ssh ${KUBE_HOST} 'kubectl scale deployment backend-deployment-${deployColor} --replicas=2'
                    """

                    // 3. ìƒˆ ë°°í¬ ë¡¤ì•„ì›ƒ ìƒíƒœ ì²´í¬
                    sh """
                        ssh ${KUBE_HOST} 'kubectl rollout status deployment/backend-deployment-${deployColor} --timeout=5m'
                    """

                    // 4. ì„œë¹„ìŠ¤ YAML íŒŒì¼ ë‚´ selector ì—…ë°ì´íŠ¸
                    // ê¸°ì¡´ "app: backend-..." íŒ¨í„´ ì „ì²´ë¥¼ ìƒˆë¡œìš´ ë°°í¬ ìƒ‰ìƒìœ¼ë¡œ êµì²´
                    sh """
                        sed -i "s/app: backend-.*\$/app: backend-${deployColor}/" ${WORKSPACE}/backend/k8s/backend-svc.yml
                    """
                    sh """
                        scp ${WORKSPACE}/backend/k8s/backend-svc.yml ${KUBE_HOST}:/home/test/backend/k8s/
                    """
                    sh """
                        ssh ${KUBE_HOST} 'kubectl apply -f /home/test/backend/k8s/backend-svc.yml'
                    """

                    // 5. ê¸°ì¡´ ë°°í¬(ë‹¤ë¥¸ ìƒ‰ìƒ)ì˜ ìŠ¤ì¼€ì¼ ë‹¤ìš´
                    sh """
                        ssh ${KUBE_HOST} 'kubectl scale deployment backend-deployment-${otherColor} --replicas=0'
                    """
                }
            }
            post {
                success {
                    sendDiscordMessage("âœ… Blue-Green ë°°í¬ ì„±ê³µ!", "${env.DEPLOY_COLOR} ë²„ì „ ë°°í¬ ì™„ë£Œ", "GREEN")
                }
                failure {
                    sendDiscordMessage("âŒ Blue-Green ë°°í¬ ì‹¤íŒ¨!", "ë°°í¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ", "RED")
                }
            }
        }

        stage('End Timer') {
            steps {
                script {
                    def endTime = System.currentTimeMillis()
                    def duration = (endTime - startTime) / 1000
                    echo "â±ï¸ ì „ì²´ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì‹œê°„: ${duration}ì´ˆ"
                }
            }
        }
    }

    post {
        success {
            script {
                def endTime = System.currentTimeMillis()
                def duration = (endTime - startTime) / 1000
                sendDiscordMessage("ğŸ‰ ì „ì²´ íŒŒì´í”„ë¼ì¸ ì„±ê³µ!", "â±ï¸ ì‹¤í–‰ ì‹œê°„: ${duration}ì´ˆ", "GREEN")
            }
        }
        failure {
            script {
                def endTime = System.currentTimeMillis()
                def duration = (endTime - startTime) / 1000
                sendDiscordMessage("ğŸš¨ ì „ì²´ íŒŒì´í”„ë¼ì¸ ì‹¤íŒ¨!", "â±ï¸ ì‹¤í–‰ ì‹œê°„: ${duration}ì´ˆ", "RED")
            }
        }
    }
}

// ì „ì—­ í•¨ìˆ˜ ì„ ì–¸ (pipeline ì™¸ë¶€)
def sendDiscordMessage(String title, String description, String color) {
    withCredentials([string(credentialsId: 'Discord-Webhook', variable: 'DISCORD')]) {
        discordSend(
            description: description,
            footer: "Jenkins CI/CD",
            link: env.BUILD_URL,
            result: currentBuild.currentResult,
            title: title,
            color: color,
            webhookURL: "$DISCORD"
        )
    }
}
